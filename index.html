<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Yuzu Survivor v1.02</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            background-color: #222; /* 외부 배경은 어둡게 */
            overflow: hidden; 
        }
        /* 2. 화면 밖 라운드 모서리 처리 */
        canvas { 
            border-radius: 20px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <script>
        class StartScene extends Phaser.Scene {
            constructor() { super('StartScene'); }
            preload() { this.load.image('main_yuzu', 'main_yuzu.webp'); }
            create() {
                // 배경 설정
                this.cameras.main.setBackgroundColor('#F5F5DC');
                this.add.image(400, 220, 'main_yuzu').setScale(0.5);
                this.add.text(400, 380, '유즈 서바이버', { font: '60px "Black Han Sans"', fill: '#444' }).setOrigin(0.5);
                this.add.text(400, 520, 'CLICK TO START', { font: '28px "Black Han Sans"', fill: '#8b4513' })
                    .setOrigin(0.5).setInteractive({ useHandCursor: true })
                    .on('pointerdown', () => this.scene.start('GameScene'));
            }
        }

        class GameScene extends Phaser.Scene {
            constructor() { super('GameScene'); }

            preload() {
                this.load.image('main_yuzu', 'main_yuzu.webp');
                this.load.image('enemy_wildyuzu', 'enemy_wildyuzu.webp');
                this.load.image('weapon_gyul', 'weapon_gyul.webp');
                this.load.image('gem', 'https://labs.phaser.io/assets/sprites/diamonds/diamond16.png');
                
                // 3. 사운드 라이브러리 재고려 (간결하고 명확한 사운드)
                this.load.audio('snd_fire', 'https://cdn.pixabay.com/audio/2022/03/15/audio_730623630f.mp3'); // 짧은 스윙
                this.load.audio('snd_hit', 'https://cdn.pixabay.com/audio/2021/08/04/audio_bb36440263.mp3');  // 가벼운 타격
                this.load.audio('snd_levelup', 'https://cdn.pixabay.com/audio/2022/03/10/audio_502755096a.mp3'); // 레벨업 알림
            }

            create() {
                // 2. 배경 베이지색 단일 톤
                this.cameras.main.setBackgroundColor('#F5F5DC');

                // 초기 시스템 값
                this.hp = 100;
                this.level = 1;
                this.exp = 0;
                this.nextExp = 50;
                this.maxLevel = 35;
                this.isGameOver = false;
                this.lastFired = 0; // 초기 발사 시간 설정

                // UI 설정
                this.expBarBg = this.add.graphics().fillStyle(0xdddddd).fillRect(0, 0, 800, 10);
                this.expBar = this.add.graphics();
                this.updateExpBar();
                this.statusText = this.add.text(20, 30, `Lv.${this.level}  HP: ${this.hp}`, { font: '24px "Black Han Sans"', fill: '#444' });

                this.player = this.physics.add.sprite(400, 300, 'main_yuzu').setScale(0.3);
                this.player.setCollideWorldBounds(true);

                this.enemies = this.physics.add.group();
                this.weapons = this.physics.add.group({ defaultKey: 'weapon_gyul', maxSize: 50 });
                this.gems = this.physics.add.group();
                
                this.cursors = this.input.keyboard.createCursorKeys();
                this.time.addEvent({ delay: 1200, callback: this.spawnEnemy, callbackScope: this, loop: true });
                
                this.physics.add.overlap(this.weapons, this.enemies, this.hitEnemy, null, this);
                this.physics.add.overlap(this.player, this.enemies, this.playerHit, null, this);
                this.physics.add.overlap(this.player, this.gems, this.collectGem, null, this);
            }

            update(time) {
                if (this.isGameOver) return;

                this.player.setVelocity(0);
                if (this.cursors.left.isDown) this.player.setVelocityX(-220);
                else if (this.cursors.right.isDown) this.player.setVelocityX(220);
                if (this.cursors.up.isDown) this.player.setVelocityY(-220);
                else if (this.cursors.down.isDown) this.player.setVelocityY(220);

                // 1. 버그 수정: 1레벨부터 공격 실행
                if (time > this.lastFired) {
                    this.fireGyul(time);
                }

                this.enemies.getChildren().forEach(enemy => {
                    this.physics.moveToObject(enemy, this.player, 100);
                });
            }

            updateExpBar() {
                this.expBar.clear();
                this.expBar.fillStyle(0xffa500); // 귤 색상으로 경험치 바 변경
                this.expBar.fillRect(0, 0, 800 * (this.exp / this.nextExp), 10);
            }

            fireGyul(time) {
                const target = this.physics.closest(this.player, this.enemies.getChildren());
                const shootCount = 1 + Math.floor(this.level / 5); 

                for (let i = 0; i < shootCount; i++) {
                    let gyul = this.weapons.get(this.player.x, this.player.y);
                    if (gyul) {
                        gyul.setActive(true).setVisible(true).setScale(0.12);
                        const angleOffset = (i * 0.3) - (shootCount * 0.15);
                        
                        if (target) {
                            // 에이밍 로직 강화
                            const angle = Phaser.Math.Angle.Between(this.player.x, this.player.y, target.x, target.y) + angleOffset;
                            this.physics.velocityFromRotation(angle, 450, gyul.body.velocity);
                        } else {
                            gyul.body.velocity.x = 450;
                        }
                        
                        this.sound.play('snd_fire', { volume: 0.2 });
                        this.time.delayedCall(1200, () => { gyul.setActive(false).setVisible(false); });
                    }
                }
                this.lastFired = time + Math.max(350, 900 - (this.level * 20));
            }

            spawnEnemy() {
                if (this.isGameOver) return;
                const spawnRange = 100;
                const x = Phaser.Math.Between(0, 1) ? -spawnRange : 800 + spawnRange;
                const y = Phaser.Math.Between(0, 600);
                this.enemies.create(x, y, 'enemy_wildyuzu').setScale(0.2);
            }

            hitEnemy(weapon, enemy) {
                weapon.setActive(false).setVisible(false);
                this.gems.create(enemy.x, enemy.y, 'gem').setScale(1.2);
                enemy.destroy();
                this.sound.play('snd_hit', { volume: 0.15 });
            }

            collectGem(player, gem) {
                gem.destroy();
                this.exp += 25;
                if (this.exp >= this.nextExp && this.level < this.maxLevel) {
                    this.levelUp();
                }
                this.updateExpBar();
                this.statusText.setText(`Lv.${this.level}  HP: ${this.hp}`);
            }

            levelUp() {
                this.level++;
                this.exp = 0;
                this.nextExp = Math.floor(this.nextExp * 1.25);
                this.sound.play('snd_levelup', { volume: 0.4 });
                
                const txt = this.add.text(400, 300, 'LEVEL UP!', { font: '40px "Black Han Sans"', fill: '#e67e22' }).setOrigin(0.5);
                this.tweens.add({ targets: txt, y: 200, alpha: 0, duration: 1000, onComplete: () => txt.destroy() });
            }

            playerHit(player, enemy) {
                enemy.destroy();
                this.hp -= 10;
                this.statusText.setText(`Lv.${this.level}  HP: ${this.hp}`);
                this.cameras.main.shake(100, 0.01);
                if (this.hp <= 0 && !this.isGameOver) this.gameOver();
            }

            gameOver() {
                this.isGameOver = true;
                this.physics.pause();
                this.player.setTint(0xff0000);
                this.add.text(400, 300, 'GAME OVER', { font: '64px "Black Han Sans"', fill: '#c0392b' }).setOrigin(0.5);
                this.add.text(400, 400, 'CLICK TO RETRY', { font: '24px "Black Han Sans"', fill: '#444' })
                    .setOrigin(0.5).setInteractive({ useHandCursor: true })
                    .on('pointerdown', () => this.scene.restart());
            }
        }

        const config = {
            type: Phaser.AUTO,
            width: 800, height: 600,
            physics: { default: 'arcade', arcade: { debug: false } },
            scene: [StartScene, GameScene]
        };
        const game = new Phaser.Game(config);
    </script>
</body>
</html>
